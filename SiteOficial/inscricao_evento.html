<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscrição - Ponte do Saber</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg bg-white py-3 mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary fs-3" href="index.html">Ponte do Saber</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navContent">
                <ul class="navbar-nav align-items-center gap-3">
                    <li class="nav-item">
                        <a class="nav-link text-dark fw-medium" href="index.html">Início</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-dark fw-medium" href="cursos.html">Cursos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-dark fw-medium" href="portal_instituicao.html">Empresa</a>
                    </li>
                    <li class="nav-item">
                        <button id="btConfig" class="btn btn-outline-secondary rounded-pill px-4 fw-bold">
                            Config
                        </button>
                    </li>
                    <li class="nav-item">
                        <button id="btLogout" class="btn btn-danger rounded-pill px-4 fw-bold">
                            Sair
                        </button>
                    </li>                    
                </ul>
            </div>
        </div>
    </nav>
    <div class="container pb-5">
        <div class="p-4 rounded-4 text-white mb-4" style="background: linear-gradient(135deg, #4a69bd, #0d1b8a);">
            <h2 id="trazer_nomeCurso" class="fw-bold mb-3">Nome do curso...</h2>
            <div id="alertaCursoInscricao"></div>
            <div class="row g-4">
                <div class="col-lg-7">
                    <div class="bg-secondary bg-opacity-10 rounded-4 w-100 h-100 overflow-hidden" style="min-height: 300px;">
                        <img src="Imagens/Capa_Curso.png" class="w-100 h-100 object-fit-cover" alt="Capa do Curso">
                    </div>
                </div>
                <div class="col-lg-5">                    
                    <label for="trazer_descricao" class="fw-bold mb-1">Descrição</label>
                    <div id="trazer_descricao" class="bg-white bg-opacity-75 text-dark rounded-3 p-2 mb-4" style="min-height: 120px; font-size: 0.9rem;">
                        Descrição do evento...
                    </div>
                    <label for="trazer_dataCurso" class="fw-bold mb-1">Início do Curso:</label>
                    <div id="trazer_dataCurso" class="text-white fs-4 fw-bold text-center py-1 rounded-3 mb-2 shadow-sm" style="background-color: #f39c12;">
                        DD/MM/AAAA
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label for="trazer_vagas" class="fw-bold small mb-1 w-100 text-center">Vagas abertas:</label>
                            <div id="trazer_vagas" class="text-white fs-5 fw-bold text-center py-1 rounded-3 mb-2 shadow-sm" style="background-color: #f39c12;">
                                0
                            </div>
                        </div>
                        <div class="col-6">
                            <label for="trazer_duracao" class="fw-bold small mb-1 w-100 text-center">Duração:</label>
                            <div id="trazer_duracao" class="text-white fs-5 fw-bold text-center py-1 rounded-3 mb-2 shadow-sm" style="background-color: #f39c12;">
                                0 horas
                            </div>
                        </div>
                    </div>
                    <label for="trazer_endereco" class="fw-bold small mb-1 w-100 text-center">Localização:</label>
                    <div id="trazer_endereco" class="text-white fs-5 fw-bold text-center py-1 rounded-3 shadow-sm" style="background-color: #f39c12;">
                        Sem endereço.
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-secondary bg-opacity-25 p-4 rounded-4 mb-5">
            <h4 class="fw-bold text-warning mb-5">INSCRIÇÃO</h4>
            <div id="alertaInscricao"></div>
            <form action="index.html">
                <div class="row g-3 mb-5">
                    <div class="col-md-7">
                        <label for="nome_Inscricao" class="fw-bold text-secondary ps-2 mb-1">Nome:</label>
                        <input id="nome_Inscricao" type="text" class="form-control rounded-pill p-2 border-0" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="cpf_Inscricao" class="fw-bold text-secondary ps-2 mb-1">CPF:</label>
                        <input id="cpf_Inscricao" type="text" class="form-control rounded-pill p-2 border-0" readonly>
                    </div>
                    <div class="col-md-1">
                        <label for="idade_Inscricao" class="fw-bold text-secondary ps-2 mb-1">Idade:</label>
                        <input id="idade_Inscricao" type="number" class="form-control rounded-pill p-2 border-0" readonly>
                    </div>
                </div>
                <div class="row g-3 mb-5">
                    <div class="col-md-6">
                        <label for="email_Inscricao" class="fw-bold text-secondary ps-2 mb-1">E-mail:</label>
                        <input id="email_Inscricao" type="email" class="form-control rounded-pill p-2 border-0" readonly>
                    </div>
                    <div class="col-md-3">
                        <label for="telefone_Inscricao" class="fw-bold text-secondary ps-2 mb-1">Telefone:</label>
                        <input id="telefone_Inscricao" type="text" class="form-control rounded-pill p-2 border-0" readonly>
                    </div>
                    <div class="col-md-3">
                        <label for="modalidade_Inscricao" class="fw-bold text-secondary ps-2 mb-1">Modalidade:</label>
                        <input id="modalidade_Inscricao" type="text" class="form-control rounded-pill p-2 border-0" readonly>
                    </div>
                </div>
                <br>
                <div class="row g-3 align-items-end">                                      
                    <div class="col-md-8">
                        <div class="d-flex flex-wrap justify-content-end align-items-center gap-4">
                            <div class="form-check">
                                <input class="form-check-input p-2" type="checkbox" id="termosInscricao" value="">
                                <label class="form-check-label small fw-bold text-secondary" for="termosInscricao">
                                    Aceito os <a href="#" class="text-primary text-decoration-none">Termos de uso</a>
                                </label>
                            </div>
                            <button type="button" id="btInscricao" class="btn btn-success rounded-pill px-5 py-3 fw-bold shadow text-uppercase" 
                                    style="background-color: #58d613; border: none; min-width: 200px; color: #1a4d03;">
                                Inscrever
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <h5 class="fw-bold text-secondary mb-3">Veja outros cursos</h5>
        <div class="row g-3">
            <div class="col-md-4">
                <div class="bg-secondary bg-opacity-10 rounded-4 w-100 overflow-hidden" style="height: 150px;">
                     <img src="Imagens/Capa_Curso.png" class="w-100 h-100 object-fit-cover" alt="Outro curso">
                </div>
            </div>
            <div class="col-md-4">
                <div class="bg-secondary bg-opacity-10 rounded-4 w-100 overflow-hidden" style="height: 150px;">
                    <img src="Imagens/Capa_Curso.png" class="w-100 h-100 object-fit-cover" alt="Outro curso">
                </div>
            </div>
            <div class="col-md-4">
                <a href="cursos.html" class="rounded-4 w-100 d-flex align-items-center justify-content-center text-white fw-bold fs-4 text-decoration-none" 
                     style="height: 150px; background-color: #0d1b8a;">
                    <span class="writing-mode-vertical">Ver Mais +</span>
                </a>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let cursoId = null; // Variável para armazenar o ID do curso globalmente

        //Função para converter a data do banco de dados de AAAA-MM-DD em DD/MM/AAAA no card do curso
        function formatarData(dataISO) {
            if (!dataISO) return "";

            const partes = dataISO.split("-");
            const ano = partes[0];
            const mes = partes[1];
            const dia = partes[2];

            return `${dia}/${mes}/${ano}`;
        };

        $(document).ready(function(){
            $('#btInscricao').on('click', function(){
                verificarInscricao();
            });
            $('#btLogout').on('click', function(){
                logout();
            });
            $('#btConfig').on('click', function(){
                window.location.href = "configuracoes.html";
            });

            // Recuperar os dados do estudante logado do localStorage
            const estudanteLogado = JSON.parse(localStorage.getItem('estudanteLogado'));
            console.log(estudanteLogado);

            //Recuperar o código para carregar os dados do curso específico
            const urlParams = new URLSearchParams(window.location.search);
            cursoId = urlParams.get('id');
            console.log('ID do curso:', cursoId);

            //Função para preencher os dados da inscrição
            if (estudanteLogado) {
                $('#nome_Inscricao').val(estudanteLogado.nome_Estd);
                $('#cpf_Inscricao').val(estudanteLogado.cpf);
                $('#idade_Inscricao').val(estudanteLogado.idade_Estd);
                $('#email_Inscricao').val(estudanteLogado.email_Estd);
                $('#telefone_Inscricao').val(estudanteLogado.telefone_Estd);
            } else {
                // Se não houver estudante logado, redirecionar para a página de login
                window.location.href = 'login.html';
            }

            //Carregar os dados do curso
            carregarDadosCurso();
        });

        //Mostrar erros da validação
        function mostrarErro(mensagem) {
            $('#alertaInscricao').html(`
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `);
        }

        function carregarDadosCurso() {
            $.ajax({
                url: 'http://localhost/ProjetoPontedoSaber/API/1/Cursos/' + cursoId,
                method: 'GET',
                dataType: 'json',

                success: function(resposta){
                    if (resposta.erro){
                        $('#alertaCursoInscricao').html(`<p class="w-100 text-center text-secondary py-4">Erro ao carregar os dados</p>`);
                    } else if (resposta.length === 0){
                        $('#alertaCursoInscricao').html(`<p class="w-100 text-center text-secondary py-4">Nenhum curso encontrado</p>`);
                    } else {
                        const curso = resposta.dados;
                        $('#trazer_nomeCurso').text(curso.nome_Curso);
                        $('#trazer_descricao').text(curso.descricao);
                        $('#trazer_dataCurso').text(formatarData(curso.data_inicio));
                        $('#trazer_vagas').text(curso.vagas_Curso);
                        $('#trazer_duracao').text(curso.duracao_Curso);
                        $('#trazer_endereco').text(curso.endereco_Curso);
                        $('#modalidade_Inscricao').val(curso.modalidade_Curso);

                    }
                },
                error: function(erro){
                    console.log('Erro ao carregar os dados:', erro);
                    $('#alertaCursoInscricao').html(`<p class="w-100 text-center text-secondary py-4">Erro de conexão com API</p>`);
                }
            });
        }

        function verificarInscricao() {
            const cpf = $('#cpf_Inscricao').val();

            $.ajax({
                url: `http://localhost/ProjetoPontedoSaber/API/1/Inscricao/verificar/${cpf}/${cursoId}`,
                method: 'GET',
                dataType: 'json',

                success: function(resposta) {
                    if (resposta.inscrito === true) {
                        $('#alertaInscricao').html(`
                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                Você já está inscrito neste curso!
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `);
                    } else {
                        inserirInscricao();
                    }
                },

                error: function(erro) {
                    $('#alertaInscricao').html(`<div class="alert alert-danger" role="alert">Erro ao verificar inscrição.</div>`);
                    console.log('Erro ao verificar inscrição:', erro);
                }
            });
        }       

        function inserirInscricao() {
            //Verificar se os termos foram aceitos
            let termos   = $('#termosInscricao').is(':checked');
            if(!termos){
                mostrarErro("Você deve aceitar os Termos de uso!");
                return;
            }
            
            const dadosInscricao = {
                data_Inscricao: new Date().toISOString().split('T')[0],
                cpf_Estudante: $('#cpf_Inscricao').val(),
                id_Curso_Inscr: cursoId,
                //campos que serão enviados como NULL
                status_Inscricao: null,
            };

            $.ajax({
                url: 'http://localhost/ProjetoPontedoSaber/API/1/Inscricao/',
                method: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(dadosInscricao),
                
                success: function(resposta){
                    let alerta = '';
                    if (resposta.erro){
                        alerta = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                            ${resposta.mensagem}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>`;
                    } else {
                        alerta = `<div class="alert alert-success alert-dismissible fade show" role="alert">
                            ${resposta.mensagem}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>`;
                    }
                    $('#alertaInscricao').html(alerta);
                },
                error: function(erro){
                    $('#alertaInscricao').html('<div class="alert alert-danger" role="alert">Erro ao comunicar com a API</div>');
                    console.log('Erro na requisição:', erro);
                }
            });
        };

        function logout() {
            localStorage.removeItem("estudanteLogado");
            window.location.href = "index.html";
        }   
    </script>
</body>
</html>